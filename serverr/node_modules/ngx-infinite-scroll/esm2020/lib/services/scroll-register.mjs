import { of, fromEvent } from 'rxjs';
import { map, mergeMap, tap, throttleTime, filter } from 'rxjs/operators';
import { AxisResolver } from './axis-resolver';
import { shouldTriggerEvents } from './event-trigger';
import { resolveContainerElement } from './ngx-ins-utils';
import { calculatePoints, createResolver } from './position-resolver';
import * as ScrollResolver from './scroll-resolver';
import { ScrollState } from './scroll-state';
export function createScroller(config) {
    const { scrollContainer, scrollWindow, element, fromRoot } = config;
    const resolver = createResolver({
        axis: new AxisResolver(!config.horizontal),
        windowElement: resolveContainerElement(scrollContainer, scrollWindow, element, fromRoot),
    });
    const scrollState = new ScrollState({
        totalToScroll: calculatePoints(element, resolver),
    });
    const options = {
        container: resolver.container,
        throttle: config.throttle,
    };
    const distance = {
        up: config.upDistance,
        down: config.downDistance,
    };
    return attachScrollEvent(options).pipe(mergeMap(() => of(calculatePoints(element, resolver))), map((positionStats) => toInfiniteScrollParams(scrollState.lastScrollPosition, positionStats, distance)), tap(({ stats }) => scrollState.updateScroll(stats.scrolled, stats.totalToScroll)), filter(({ fire, scrollDown, stats: { totalToScroll } }) => shouldTriggerEvents(config.alwaysCallback, fire, scrollState.isTriggeredScroll(totalToScroll, scrollDown))), tap(({ scrollDown, stats: { totalToScroll } }) => {
        scrollState.updateTriggeredFlag(totalToScroll, scrollDown);
    }), map(toInfiniteScrollAction));
}
export function attachScrollEvent(options) {
    let obs = fromEvent(options.container, 'scroll');
    // For an unknown reason calling `sampleTime()` causes trouble for many users, even with `options.throttle = 0`.
    // Let's avoid calling the function unless needed.
    // Replacing with throttleTime seems to solve the problem
    // See https://github.com/orizens/ngx-infinite-scroll/issues/198
    if (options.throttle) {
        obs = obs.pipe(throttleTime(options.throttle, undefined, {
            leading: true,
            trailing: true,
        }));
    }
    return obs;
}
export function toInfiniteScrollParams(lastScrollPosition, stats, distance) {
    const { scrollDown, fire } = ScrollResolver.getScrollStats(lastScrollPosition, stats, distance);
    return {
        scrollDown,
        fire,
        stats,
    };
}
export const InfiniteScrollActions = {
    DOWN: '[NGX_ISE] DOWN',
    UP: '[NGX_ISE] UP',
};
export function toInfiniteScrollAction(response) {
    const { scrollDown, stats: { scrolled: currentScrollPosition }, } = response;
    return {
        type: scrollDown ? InfiniteScrollActions.DOWN : InfiniteScrollActions.UP,
        payload: {
            currentScrollPosition,
        },
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsLXJlZ2lzdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWluZmluaXRlLXNjcm9sbC9zcmMvbGliL3NlcnZpY2VzL3Njcm9sbC1yZWdpc3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RFLE9BQU8sS0FBSyxjQUFjLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTdDLE1BQU0sVUFBVSxjQUFjLENBQUMsTUFBd0I7SUFDckQsTUFBTSxFQUFFLGVBQWUsRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxHQUFHLE1BQU0sQ0FBQztJQUNwRSxNQUFNLFFBQVEsR0FBRyxjQUFjLENBQUM7UUFDOUIsSUFBSSxFQUFFLElBQUksWUFBWSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztRQUMxQyxhQUFhLEVBQUUsdUJBQXVCLENBQ3BDLGVBQWUsRUFDZixZQUFZLEVBQ1osT0FBTyxFQUNQLFFBQVEsQ0FDVDtLQUNGLENBQUMsQ0FBQztJQUNILE1BQU0sV0FBVyxHQUFHLElBQUksV0FBVyxDQUFDO1FBQ2xDLGFBQWEsRUFBRSxl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Q0FBQyxDQUFDLENBQUMscUJBQXFCLENBQUMsRUFBRTtRQUN4RSxPQUFPLEVBQUU7WUFDUCxxQkFBcUI7U0FDdEI7S0FDRixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBmcm9tRXZlbnQgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgbWVyZ2VNYXAsIHRhcCwgdGhyb3R0bGVUaW1lLCBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCAqIGFzIE1vZGVscyBmcm9tICcuLi8uLi9tb2RlbHMnO1xuaW1wb3J0IHsgQXhpc1Jlc29sdmVyIH0gZnJvbSAnLi9heGlzLXJlc29sdmVyJztcbmltcG9ydCB7IHNob3VsZFRyaWdnZXJFdmVudHMgfSBmcm9tICcuL2V2ZW50LXRyaWdnZXInO1xuaW1wb3J0IHsgcmVzb2x2ZUNvbnRhaW5lckVsZW1lbnQgfSBmcm9tICcuL25neC1pbnMtdXRpbHMnO1xuaW1wb3J0IHsgY2FsY3VsYXRlUG9pbnRzLCBjcmVhdGVSZXNvbHZlciB9IGZyb20gJy4vcG9zaXRpb24tcmVzb2x2ZXInO1xuaW1wb3J0ICogYXMgU2Nyb2xsUmVzb2x2ZXIgZnJvbSAnLi9zY3JvbGwtcmVzb2x2ZXInO1xuaW1wb3J0IHsgU2Nyb2xsU3RhdGUgfSBmcm9tICcuL3Njcm9sbC1zdGF0ZSc7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVTY3JvbGxlcihjb25maWc6IE1vZGVscy5JU2Nyb2xsZXIpIHtcbiAgY29uc3QgeyBzY3JvbGxDb250YWluZXIsIHNjcm9sbFdpbmRvdywgZWxlbWVudCwgZnJvbVJvb3QgfSA9IGNvbmZpZztcbiAgY29uc3QgcmVzb2x2ZXIgPSBjcmVhdGVSZXNvbHZlcih7XG4gICAgYXhpczogbmV3IEF4aXNSZXNvbHZlcighY29uZmlnLmhvcml6b250YWwpLFxuICAgIHdpbmRvd0VsZW1lbnQ6IHJlc29sdmVDb250YWluZXJFbGVtZW50KFxuICAgICAgc2Nyb2xsQ29udGFpbmVyLFxuICAgICAgc2Nyb2xsV2luZG93LFxuICAgICAgZWxlbWVudCxcbiAgICAgIGZyb21Sb290XG4gICAgKSxcbiAgfSk7XG4gIGNvbnN0IHNjcm9sbFN0YXRlID0gbmV3IFNjcm9sbFN0YXRlKHtcbiAgICB0b3RhbFRvU2Nyb2xsOiBjYWxjdWxhdGVQb2ludHMoZWxlbWVudCwgcmVzb2x2ZXIpLFxuICB9KTtcbiAgY29uc3Qgb3B0aW9uczogTW9kZWxzLklTY3JvbGxSZWdpc3RlckNvbmZpZyA9IHtcbiAgICBjb250YWluZXI6IHJlc29sdmVyLmNvbnRhaW5lcixcbiAgICB0aHJvdHRsZTogY29uZmlnLnRocm90dGxlLFxuICB9O1xuICBjb25zdCBkaXN0YW5jZSA9IHtcbiAgICB1cDogY29uZmlnLnVwRGlzdGFuY2UsXG4gICAgZG93bjogY29uZmlnLmRvd25EaXN0YW5jZSxcbiAgfTtcbiAgcmV0dXJuIGF0dGFjaFNjcm9sbEV2ZW50KG9wdGlvbnMpLnBpcGUoXG4gICAgbWVyZ2VNYXAoKCkgPT4gb2YoY2FsY3VsYXRlUG9pbnRzKGVsZW1lbnQsIHJlc29sdmVyKSkpLFxuICAgIG1hcCgocG9zaXRpb25TdGF0czogTW9kZWxzLklQb3NpdGlvblN0YXRzKSA9PlxuICAgICAgdG9JbmZpbml0ZVNjcm9sbFBhcmFtcyhcbiAgICAgICAgc2Nyb2xsU3RhdGUubGFzdFNjcm9sbFBvc2l0aW9uLFxuICAgICAgICBwb3NpdGlvblN0YXRzLFxuICAgICAgICBkaXN0YW5jZVxuICAgICAgKVxuICAgICksXG4gICAgdGFwKCh7IHN0YXRzIH06IE1vZGVscy5JU2Nyb2xsUGFyYW1zKSA9PlxuICAgICAgc2Nyb2xsU3RhdGUudXBkYXRlU2Nyb2xsKHN0YXRzLnNjcm9sbGVkLCBzdGF0cy50b3RhbFRvU2Nyb2xsKVxuICAgICksXG4gICAgZmlsdGVyKFxuICAgICAgKHsgZmlyZSwgc2Nyb2xsRG93biwgc3RhdHM6IHsgdG90YWxUb1Njcm9sbCB9IH06IE1vZGVscy5JU2Nyb2xsUGFyYW1zKSA9PlxuICAgICAgICBzaG91bGRUcmlnZ2VyRXZlbnRzKFxuICAgICAgICAgIGNvbmZpZy5hbHdheXNDYWxsYmFjayxcbiAgICAgICAgICBmaXJlLFxuICAgICAgICAgIHNjcm9sbFN0YXRlLmlzVHJpZ2dlcmVkU2Nyb2xsKHRvdGFsVG9TY3JvbGwsIHNjcm9sbERvd24pXG4gICAgICAgIClcbiAgICApLFxuICAgIHRhcCgoeyBzY3JvbGxEb3duLCBzdGF0czogeyB0b3RhbFRvU2Nyb2xsIH0gfTogTW9kZWxzLklTY3JvbGxQYXJhbXMpID0+IHtcbiAgICAgIHNjcm9sbFN0YXRlLnVwZGF0ZVRyaWdnZXJlZEZsYWcodG90YWxUb1Njcm9sbCwgc2Nyb2xsRG93bik7XG4gICAgfSksXG4gICAgbWFwKHRvSW5maW5pdGVTY3JvbGxBY3Rpb24pXG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hTY3JvbGxFdmVudChcbiAgb3B0aW9uczogTW9kZWxzLklTY3JvbGxSZWdpc3RlckNvbmZpZ1xuKTogT2JzZXJ2YWJsZTx7fT4ge1xuICBsZXQgb2JzID0gZnJvbUV2ZW50KG9wdGlvbnMuY29udGFpbmVyLCAnc2Nyb2xsJyk7XG4gIC8vIEZvciBhbiB1bmtub3duIHJlYXNvbiBjYWxsaW5nIGBzYW1wbGVUaW1lKClgIGNhdXNlcyB0cm91YmxlIGZvciBtYW55IHVzZXJzLCBldmVuIHdpdGggYG9wdGlvbnMudGhyb3R0bGUgPSAwYC5cbiAgLy8gTGV0J3MgYXZvaWQgY2FsbGluZyB0aGUgZnVuY3Rpb24gdW5sZXNzIG5lZWRlZC5cbiAgLy8gUmVwbGFjaW5nIHdpdGggdGhyb3R0bGVUaW1lIHNlZW1zIHRvIHNvbHZlIHRoZSBwcm9ibGVtXG4gIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vb3JpemVucy9uZ3gtaW5maW5pdGUtc2Nyb2xsL2lzc3Vlcy8xOThcbiAgaWYgKG9wdGlvbnMudGhyb3R0bGUpIHtcbiAgICBvYnMgPSBvYnMucGlwZShcbiAgICAgIHRocm90dGxlVGltZShvcHRpb25zLnRocm90dGxlLCB1bmRlZmluZWQsIHtcbiAgICAgICAgbGVhZGluZzogdHJ1ZSxcbiAgICAgICAgdHJhaWxpbmc6IHRydWUsXG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgcmV0dXJuIG9icyBhcyBhbnk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0b0luZmluaXRlU2Nyb2xsUGFyYW1zKFxuICBsYXN0U2Nyb2xsUG9zaXRpb246IG51bWJlcixcbiAgc3RhdHM6IE1vZGVscy5JUG9zaXRpb25TdGF0cyxcbiAgZGlzdGFuY2U6IE1vZGVscy5JU2Nyb2xsZXJEaXN0YW5jZVxuKTogTW9kZWxzLklTY3JvbGxQYXJhbXMge1xuICBjb25zdCB7IHNjcm9sbERvd24sIGZpcmUgfSA9IFNjcm9sbFJlc29sdmVyLmdldFNjcm9sbFN0YXRzKFxuICAgIGxhc3RTY3JvbGxQb3NpdGlvbixcbiAgICBzdGF0cyxcbiAgICBkaXN0YW5jZVxuICApO1xuICByZXR1cm4ge1xuICAgIHNjcm9sbERvd24sXG4gICAgZmlyZSxcbiAgICBzdGF0cyxcbiAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IEluZmluaXRlU2Nyb2xsQWN0aW9ucyA9IHtcbiAgRE9XTjogJ1tOR1hfSVNFXSBET1dOJyxcbiAgVVA6ICdbTkdYX0lTRV0gVVAnLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHRvSW5maW5pdGVTY3JvbGxBY3Rpb24oXG4gIHJlc3BvbnNlOiBNb2RlbHMuSVNjcm9sbFBhcmFtc1xuKTogTW9kZWxzLklJbmZpbml0ZVNjcm9sbEFjdGlvbiB7XG4gIGNvbnN0IHtcbiAgICBzY3JvbGxEb3duLFxuICAgIHN0YXRzOiB7IHNjcm9sbGVkOiBjdXJyZW50U2Nyb2xsUG9zaXRpb24gfSxcbiAgfSA9IHJlc3BvbnNlO1xuICByZXR1cm4ge1xuICAgIHR5cGU6IHNjcm9sbERvd24gPyBJbmZpbml0ZVNjcm9sbEFjdGlvbnMuRE9XTiA6IEluZmluaXRlU2Nyb2xsQWN0aW9ucy5VUCxcbiAgICBwYXlsb2FkOiB7XG4gICAgICBjdXJyZW50U2Nyb2xsUG9zaXRpb24sXG4gICAgfSxcbiAgfTtcbn1cbiJdfQ==